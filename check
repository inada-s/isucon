#!/bin/bash -x
SCRIPT_DIR=$(cd $(dirname $0) && pwd)
cd $SCRIPT_DIR

mkdir -p ./htmldump/tmp
mkdir -p ./htmldump/ref

if [ "$1" = "ref" ]; then
  rm ./htmldump/ref/*
  cd ./htmldump/ref
else
  rm ./htmldump/tmp/*
  cd ./htmldump/tmp
fi

#curl localhost/initialize
CURL="curl -sSLc cookie.txt -w %{time_total}\\n"
$CURL localhost -o get-index.html
$CURL -d "login=isucon1" -d "password=isuconpass1" http://localhost/login -o post-login-ok.html
$CURL localhost/mypage -o get-mypage.html
$CURL localhost -o get-index2.html
$CURL localhost/report -o get-report.html

DIFF='diff -uBw'
if [[ -x `which colordiff` ]]; then
    DIFF='colordiff -uBw'
fi

if [ "$1" != "ref" ]; then
  cd $SCRIPT_DIR
  ls ./htmldump/ref | grep -v "cookie.txt" | while read line; do
    $DIFF ./htmldump/ref/$line ./htmldump/tmp/$line
  done
fi
